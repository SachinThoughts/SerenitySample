RelatedInvoices_439227_SQL1=declare @InvoiceID int declare @RegistrationID int declare @MRN_Number varchar(50) = '%s' set @InvoiceID = (select Id from invoices where invoicenumber ='%s' ) set @RegistrationID = (select RegistrationID from invoices where invoicenumber ='%s' ) SELECT R.ID AS RegistrationID,R.EncounterID AS AccountNumber,R.FacilityPatientID,R.FacilityCode FROM Registrations R WHERE  R.FacilityPatientID=@MRN_Number AND R.ID<>CASE WHEN @InvoiceID=0 THEN @RegistrationID ELSE 0 END UNION ALL SELECT I.RegistrationID AS RegistrationID,I.EncounterID  AS AccountNumber,I.FacilityPatientID,R.FacilityCode FROM Invoices I INNER JOIN Registrations R ON R.ID=I.RegistrationID WHERE I.IsActive=1 AND R.FacilityPatientID=@MRN_Number  AND I.ID <>@InvoiceID