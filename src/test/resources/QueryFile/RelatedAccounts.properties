RelatedInvoices_439227_SQL1=declare @InvoiceID int declare @RegistrationID int declare @MRN_Number varchar(50) = '%s' set @InvoiceID = (select Id from invoices where invoicenumber ='%s' ) set @RegistrationID = (select RegistrationID from invoices where invoicenumber ='%s' ) SELECT R.ID AS RegistrationID,R.EncounterID AS AccountNumber,R.FacilityPatientID,R.FacilityCode FROM Registrations R WHERE  R.FacilityPatientID=@MRN_Number AND R.ID<>CASE WHEN @InvoiceID=0 THEN @RegistrationID ELSE 0 END UNION ALL SELECT I.RegistrationID AS RegistrationID,I.EncounterID  AS AccountNumber,I.FacilityPatientID,R.FacilityCode FROM Invoices I INNER JOIN Registrations R ON R.ID=I.RegistrationID WHERE I.IsActive=1 AND R.FacilityPatientID=@MRN_Number  AND I.ID <>@InvoiceID
RelatedInvoices_439237_SQL3=DECLARE @FacilityPatientID NVARCHAR(20)='%s' DECLARE @InvoiceID INT=(select Id from invoices where invoicenumber ='%s' ) DECLARE @RegistrationID INT=(select RegistrationID from invoices where invoicenumber ='%s' ) DECLARE @ApplicationID INT=1 DECLARE @PageNumber	INT = 1 DECLARE  @PageSize	INT =20 SET NOCOUNT ON; SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED DECLARE @RecordKeyTypeID INT SELECT @RecordKeyTypeID = ID FROM Accretive_RecordKeyMaster WHERE RecordKeyType  = 'InvoiceID' SELECT R.ID AS RegistrationID,R.EncounterID AS AccountNumber,R.FacilityPatientID,R.FacilityCode,isnull(Convert(VARCHAR(10),R.AdmitDate,101),'N/A')as AdmitDate, isnull(Convert(VARCHAR(10),R.DischargeDate,101),'N/A')as DischargeDate,R.PatientType,isnull(PS.CurrentPayorPlanCode,'-')as CurrentPayorPlanCode,isnull(CONVERT(VARCHAR,PS.EncounterInsuranceBalance),'N/A')as InsuranceBalance,isnull(CONVERT(VARCHAR,PS.EncounterPatientBalance),'N/A')as PatientBalance,isnull(DT.DefectTypedesc,'Unclassified')as DefectTypeDesc,isnull(dsc.DefectSubCategoryDesc,'Unclassified')as DefectSubCategoryDesc,'N/A' AS [InvoiceNumber],0 AS InvoiceID,null SequenceNumber,R.AdmitDate AS  AdmitDateSeq FROM Registrations R left outer join Payer.DefectAccount as DA on da.RegistrationID =R.id  AND DA.InvoiceID =0 left outer join accretive_DefectSubCategory as DSC on da.DefectSubCategoryID = dsc.DefectSubCategoryID left outer join accretive_DefectType AS DT ON  DT.DefectTypeID = DSC.DefectTypeID AND DT.ApplicationID IN(Select ApplicationID FROM Accretive_Application WHERE ApplicationName IN('AHtoDecision','R1DProfessional')) left outer join [dbo].[PaymentsSummary] AS PS ON R.id=PS.RegistrationID WHERE  R.FacilityPatientID=@FacilityPatientID AND R.ID<>CASE WHEN @InvoiceID=0 THEN @RegistrationID ELSE 0 END	UNION ALL SELECT I.RegistrationID AS RegistrationID,I.EncounterID  AS AccountNumber,I.FacilityPatientID ,R.FacilityCode,ISNULL(CONVERT(VARCHAR(10),I.AdmitDate,101),'N/A')as AdmitDate,ISNULL(CONVERT(VARCHAR(10),I.DischargeDate,101),'N/A')as DischargeDate,I.PatientType,ISNULL(I.CurrentPayorPlanCode,'-')as CurrentPayorPlanCode,ISNULL(CONVERT(VARCHAR,MLVPS.EncounterInsuranceBalance),'N/A')as InsuranceBalance,ISNULL(CONVERT(VARCHAR,MLVPS.EncounterPatientBalance),'N/A')as PatientBalance,ISNULL(DT.DefectTypedesc,'Unclassified')as DefectTypeDesc, ISNULL(dsc.DefectSubCategoryDesc,'Unclassified')as DefectSubCategoryDesc, I.InvoiceNumber,I.ID AS InvoiceID,row_number() over(order by I.admitdate desc ) as SequenceNumber,R.AdmitDate AS AdmitDateSeq FROM Invoices I INNER JOIN Registrations R ON R.ID=I.RegistrationID left outer join Payer.DefectAccount as DA on DA.InvoiceID =I.ID LEFT OUTER JOIN MultilevelPaymentSummary MLVPS ON MLVPS.RECORDKEY = I.ID AND RecordKeyTypeID= @RecordKeyTypeID left outer join accretive_DefectSubCategory as DSC on DA.DefectSubCategoryID = dsc.DefectSubCategoryID left outer join accretive_DefectType AS DT ON  DT.DefectTypeID = DSC.DefectTypeID AND DT.ApplicationID IN(Select ApplicationID FROM Accretive_Application WHERE ApplicationName IN('AHtoDecision','R1DProfessional')) WHERE I.IsActive=1 AND R.FacilityPatientID=@FacilityPatientID  AND I.ID <>@InvoiceID ORDER BY SequenceNumber DESC,AdmitDate desc,RegistrationID